<!DOCTYPE html>
<html>
<head>
  <title>Oral Care Products</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <style>
    .miniCards {
      width: 220px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      padding: 10px;
      background: white;
      transition: transform 0.3s;
      margin: 15px;
    }
    .miniCards:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .miniCardsImages {
      width: 100%;
      height: 140px;
      object-fit: contain;
      margin: 0 auto;
    }
    .miniCardsDescription {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      height: 40px;
      overflow: hidden;
      margin: 10px 0;
    }
    .price {
      font-weight: bold;
      font-size: 16px;
      color: #28a745;
    }
    .mrp {
      text-decoration: line-through;
      color: #6c757d;
      font-size: 14px;
    }
    .discount {
      color: #dc3545;
      font-size: 14px;
      font-weight: bold;
    }
    .addButton {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
    }
    .addButton:hover {
      background: #0069d9;
    }
    .addButton:disabled {
      background: #6c757d;
    }
    .instantRelief {
      color: #2d3748;
      font-weight: 700;
      margin-left: 20px;
    }
    .products-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div class="mt-5">
    <h1 class="instantRelief">Oral Care</h1>
  </div>

  <!-- Products Container -->
  <div class="container mt-3">
    <div id="products-container" class="products-grid"></div>
  </div>

  <!-- Firebase & Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
  <!-- Firebase SDK (using COMPAT version for simpler syntax) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBNSpayhzItGiJB4llF93ICW_jIgrvgPak",
      authDomain: "medicine-delivery-130aa.firebaseapp.com",
      projectId: "medicine-delivery-130aa",
      storageBucket: "medicine-delivery-130aa.appspot.com",
      messagingSenderId: "539898474363",
      appId: "1:539898474363:web:2debf03eb6a2f33e65d7de",
      measurementId: "G-H3RBF4GRNX"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Load Products from Firestore
    async function loadProducts() {
      const container = document.getElementById('products-container');
      container.innerHTML = `
        <div class="w-100 text-center py-5">
          <div class="loading-spinner"></div>
          <p class="mt-2">Loading products...</p>
        </div>
      `;

      try {
        const querySnapshot = await db.collection("products").get();
        
        if (querySnapshot.empty) {
          container.innerHTML = `
            <div class="w-100 text-center py-5">
              <i class="fas fa-box-open fa-3x text-muted"></i>
              <p class="mt-2">No products found</p>
            </div>
          `;
          return;
        }

        container.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const product = doc.data();
          const productId = doc.id;
          
          container.innerHTML += `
            <div class="miniCards">
              <img src="${product.image || 'https://via.placeholder.com/150'}" 
                   class="miniCardsImages" 
                   alt="${product.name || 'Product image'}"
                   onerror="this.src='https://via.placeholder.com/150'">
              <p class="miniCardsDescription">${product.name || 'Unnamed Product'}</p>
              <div class="price">
                <i class="fa-solid fa-indian-rupee-sign"></i>
                ${product.price?.toFixed(2) || '0.00'}
                ${product.mrp ? `<span class="mrp ml-2">MRP â‚¹${product.mrp.toFixed(2)}</span>` : ''}
                ${product.discount ? `<span class="discount ml-2">${product.discount}</span>` : ''}
              </div>
              <button class="addButton mt-2" data-id="${productId}">
                ADD
              </button>
            </div>
          `;
        });

        // Add event listeners to all buttons
        document.querySelectorAll('.addButton').forEach(button => {
          button.addEventListener('click', addToCart);
        });

      } catch (error) {
        console.error("Error loading products:", error);
        container.innerHTML = `
          <div class="alert alert-danger w-100">
            <i class="fas fa-exclamation-triangle"></i>
            Failed to load products: ${error.message}
            <button onclick="loadProducts()" class="btn btn-sm btn-warning mt-2">
              <i class="fas fa-sync-alt"></i> Try Again
            </button>
          </div>
        `;
      }
    }

    // Add to Cart Function
    async function addToCart(event) {
      const button = event.target;
      const productId = button.dataset.id;
      const productCard = button.closest('.miniCards');
      
      // Disable button during processing
      button.disabled = true;
      button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Adding...';

      try {
        const user = auth.currentUser;
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        const productData = {
          name: productCard.querySelector('.miniCardsDescription').textContent,
          price: parseFloat(productCard.querySelector('.price').textContent.match(/[\d.]+/)[0]),
          image: productCard.querySelector('img').src,
          quantity: 1,
          lastUpdated: new Date()
        };

        // Firestore cart update
        await db.collection("users").doc(user.uid).collection("cart").doc(productId).set({
          ...productData,
          quantity: firebase.firestore.FieldValue.increment(1)
        }, { merge: true });

        // Visual feedback
        button.innerHTML = '<i class="fas fa-check"></i> ADDED!';
        button.style.backgroundColor = '#28a745';
        
        // Reset button after 2 seconds
        setTimeout(() => {
          button.innerHTML = 'ADD';
          button.style.backgroundColor = '';
          button.disabled = false;
        }, 2000);

      } catch (error) {
        console.error("Add to cart error:", error);
        button.innerHTML = '<i class="fas fa-times"></i> Error';
        button.style.backgroundColor = '#dc3545';
        
        setTimeout(() => {
          button.innerHTML = 'ADD';
          button.style.backgroundColor = '';
          button.disabled = false;
        }, 2000);
        
        alert('Error: ' + error.message);
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      auth.onAuthStateChanged((user) => {
        if (user) {
          console.log("User logged in:", user.uid);
        } else {
          console.log("No user logged in");
        }
        loadProducts();
      });
    });
  </script>
</body>
</html>